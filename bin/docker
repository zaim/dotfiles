#!/bin/bash


# Customizable variables
# ----------------------

# The version of docker to use:
DOCKER_VERSION=${DOCKER_VERSION:-0.7.0}

# The path to put docker's Vagrantfile in:
DOCKER_ROOT=${DOCKER_ROOT:-$HOME/.docker}

# The github repo to use:
GITHUB_REPO=${GITHUB_REPO:-dotcloud/docker}

# Other env variables used by docker's Vagrantfile:
# Must be prefixed with DOCKER_, for example, add below to .bashrc:
#
#   export DOCKER_BOX_NAME=precise64
#
# To use the "precise64" Vagrant box name instead of the default "ubuntu"

for n in BOX_NAME BOX_URI VF_BOX_URI AWS_BOX_URI AWS_REGION AWS_AMI \
  AWS_INSTANCE_TYPE SSH_PRIVKEY_PATH; do
  _nn=DOCKER_${n}
  declare ${n}=${!_nn}
done


# Functions
# ---------

download_vagrantfile() {
  _url="https://raw.github.com/${GITHUB_REPO}/v${DOCKER_VERSION}/Vagrantfile"
  echo "Downloading Vagrantfile" >&2
  echo "$_url" >&2
  echo "$DOCKER_VERSION" > "$DOCKER_ROOT/VERSION"
  curl -sS "$_url" > "$DOCKER_ROOT/Vagrantfile"
}


# Main program
# ------------

if [ ! -d "$DOCKER_ROOT" ]; then
  mkdir "$DOCKER_ROOT"
fi

if [ ! -f $DOCKER_ROOT/Vagrantfile ]; then
  download_vagrantfile
else
  # Check if a different Vagrantfile version from DOCKER_VERSION is used
  _current=`cat "$DOCKER_ROOT/VERSION"`
  if [ "$_current" != "$DOCKER_VERSION" ]; then
    download_vagrantfile
  fi
fi

cd "$DOCKER_ROOT"

case "$1" in
  "vup")
    eval vagrant up
    ;;
  "vsuspend")
    eval vagrant suspend
    ;;
  "vhalt")
    eval vagrant halt
    ;;
  "vresume")
    eval vagrant resume
    ;;
  "vstatus")
    eval vagrant status
    ;;
  "vssh")
    shift
    eval vagrant ssh $@
    ;;
  "help")
    echo "See https://docs.docker.io/en/latest/commandline for docker help."
    echo ""
    echo "Extra commands for Vagrant VM operations is prefixed with 'v':"
    echo "    vup"
    echo "    vsuspend"
    echo "    vhalt"
    echo "    vresume"
    echo "    vstatus"
    echo "    vssh"
    echo ""
    ;;
  *)
    eval 'vagrant ssh -c "docker '$@'"'
    ;;
esac

