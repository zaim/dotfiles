#!/bin/bash

hostname=$1
ip=${2:-127.0.0.1}
hostfile=/etc/hosts
syshosts=/etc/hosts.system
tmphosts=$HOME/.hosts.tmp
config=$HOME/.hosts.json

if [ ! -f "$syshosts" ]; then
  sudo cp "$hostfile" "$syshosts" &>/dev/null
  if [ $? -ne 0 ]; then
    echo "failed to create $syshosts" >&2
    exit
  fi
fi

if [ ! -f "$config" ]; then
  echo '[]' > "$config"
fi

if [ -n "$hostname" ]; then
(
python <<EOF
import json
with open('$config', 'r') as f:
  config = json.load(f)
config = set(config or [])
entry = '$ip\t$hostname'
config.add(entry)
with open('$config', 'w') as f:
  json.dump(list(config), f)
print '#'
print '# autogenerated by zaim'
print '#'
for h in sorted(config):
  print h
EOF
) > $tmphosts
  if [ $? -ne 0 ]; then
    echo "failed to output generated hosts" >&2
    exit
  fi
  sudo sh -c "cat $syshosts $tmphosts > $hostfile" &>/dev/null
  rm $tmphosts
  echo $hostname
else
  echo "Usage: $(basename $0) HOSTNAME"
  echo
  echo "Safely adds HOSTNAME.local to /etc/hosts"
  echo
  echo -n "Current custom hosts: "
  python -mjson.tool $config
fi

