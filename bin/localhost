#!/bin/bash

project=$1
hostfile=/etc/hosts
syshosts=/etc/hosts.system
tmphosts=$HOME/.hosts.tmp
config=$HOME/.hosts.json

if [ ! -f "$syshosts" ]; then
  sudo cp "$hostfile" "$syshosts" &>/dev/null
  if [ $? -ne 0 ]; then
    echo "failed to create $syshosts" >&2
    exit
  fi
fi

if [ ! -f "$config" ]; then
  echo '[]' > "$config"
fi

if [ -n "$project" ]; then
  hostname=${project}.local
(
python <<EOF
import json
with open('$config', 'r') as f:
  config = json.load(f)
config = set(config or [])
if '$hostname' not in config:
  config.add('$hostname')
with open('$config', 'w') as f:
  json.dump(list(config), f)
print '#'
print '# autogenerated by zaim'
print '#'
for h in config:
  print '%s\t%s' % ('127.0.0.1', h)
EOF
) > $tmphosts
  if [ $? -ne 0 ]; then
    echo "failed to output generated hosts" >&2
    exit
  fi
  sudo sh -c "cat $syshosts $tmphosts > $hostfile" &>/dev/null
  rm $tmphosts
  echo $hostname
fi

